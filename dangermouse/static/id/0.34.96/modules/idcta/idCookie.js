define("idcta/idCookie",["idcta/id-config","idcta/webtoolkit.base64","idcta/apiUtils"],function(h,g,b){var f={};var j=86400000;f.USER_DETAILS_COOKIE_NAME="ckns_id";f.USER_DETAILS_COOKIE_EXPIRE_TIME=7200000;f.ENCODE=true;f.DECODE=true;var a;function d(){try{if(a){a.refreshCookie();return a}a=new e();return a}catch(l){b.logCaughtError(l)}}function c(l){try{a=l}catch(m){b.logCaughtError(m)}}function i(){try{if(typeof(document)!="undefined"&&typeof(document.cookie)!="undefined"){var n=d();var l=1445925600000;if(n.hasCookie()&&n.timestamp!==""&&parseInt(n.timestamp)>0&&parseInt(n.timestamp)<l&&!n.isDowngraded()){n.downgrade()}}}catch(m){b.logCaughtError(m)}}function k(o){try{var m=g.decode(o);var l=m.lastIndexOf("}");var p=m.substring(0,l+1);return JSON.parse(p)}catch(n){return null}}function e(){var z=this;this.valid=false;this.id="";this.username="~";this.displayname="";this.timestamp="";this.cookieAgeDays=(typeof h.identity!="undefined"&&h.identity.cookieAgeDays)?h.identity.cookieAgeDays:730;this.isIdv5On=h["bbcid-v5"]!=="RED";this.domain="."+(h.idapp&&h.idapp.tld)?h.idapp.tld:"bbc.co.uk";r();this.refreshCookie=function(){try{m()}catch(A){b.logCaughtError(A)}};this.hasCookie=function(){try{if(x(z.timestamp)){w()}return z.valid}catch(A){b.logCaughtError(A)}};this.hasAccessTokenExpired=function(){try{var D=this.getUserDetailsFromCookie();if(!D){return true}var C=(new Date()).getTime();var A=D["tkn-exp"]||0;return A<=C}catch(B){b.logCaughtError(B)}};this.hasJwtTokenExpired=function(){try{var D=this.getUserDetailsFromCookie();if(!D){return true}var C=(new Date()).getTime();var A=D["jwt-exp"]||0;return A<=C}catch(B){b.logCaughtError(B)}};this.isHybridApp=function(){try{var B=this.getUserDetailsFromCookie();return B?(B.hy||false):false}catch(A){b.logCaughtError(A)}};this.getError=function(){try{var B=this.getUserDetailsFromCookie();return B?(B.ec||null):null}catch(A){b.logCaughtError(A)}};this.getIdFromCookie=function(){try{if(x(z.timestamp)){w()}if(z.isIdv5On){var B=this.getUserDetailsFromCookie();return B?B.ps:null}else{return z.id?z.id:null}}catch(A){b.logCaughtError(A)}};this.getUserDetailsFromCookie=function(){try{if(!z.isIdv5On){return null}var B=/ckns_id=([\w]+)/;var D=document.cookie.match(B);if(!D){return null}var A=decodeURIComponent(D[1]).split("|");var C=k(A.toString());if(!C||!u(C)){return null}return C}catch(E){b.logCaughtError(E)}};this.getNameFromCookie=function(){try{if(x(z.timestamp)){w()}if(z.displayname&&z.displayname!==""){return z.displayname.replace(/\+/g," ")}if(z.username&&z.username.charAt(0)!=="~"){return z.username}return null}catch(A){b.logCaughtError(A)}};this.getAccessToken=function(E){try{var A,C,B;E=(typeof E!="undefined")?E:s();if(!this.hasCookie()||E.indexOf("https")==-1){return null}A=(typeof h.identity.accessTokenCookieName!="undefined")?h.identity.accessTokenCookieName:"ckns_IDA-ATKN";B=new RegExp(A+"=([^;]*)");C=document.cookie.match(B);return(C!==null)?C[1]:null}catch(D){b.logCaughtError(D)}};this.isDowngraded=function(){try{var A=document.cookie.match(/ckpf_ID_DOWNGRADED=1/);if(A){return true}return false}catch(B){b.logCaughtError(B)}};this.hasIplayerUplift=function(){try{return document.cookie.match(/ckpf_tviplayer_uplift=([^;]*)/)}catch(A){b.logCaughtError(A)}};this.downgrade=function(){try{var C=Date.now()+(z.cookieAgeDays*j);var A=new Date(C-(Date.now()-z.timestamp));z.setCookie("ckpf_ID_DOWNGRADED","1",A.toUTCString());if(z.hasIplayerUplift()){z.unsetCookie("ckpf_tviplayer_uplift")}z.unsetCookie("ckns_IDA-RTKN");z.unsetCookie("ckns_IDA-IDTKN");z.unsetCookie("ckns_IDA-ATKN");z.unsetCookie("ckns_authToken")}catch(B){b.logCaughtError(B)}};this.setDualMode=function(){try{var A=Date.now()+(j*30);var C=parseInt(z.timestamp)+(z.cookieAgeDays*j);var B=new Date(Math.min(A,C));z.setCookie("ckns_dual","1",this.rememberme?B.toUTCString():null)}catch(D){b.logCaughtError(D)}};this.isDualMode=function(){try{var B=document.cookie.match(/ckns_dual=1/);var D=(typeof D!="undefined")?D:s();var A=(D.indexOf("https")==-1);if(A&&B){return true}return false}catch(C){b.logCaughtError(C)}};this.setCookie=function(C,G,B,E){try{G=G||"";var A="";if(B){var F=new Date();F.setTime(F.getTime()+B);A="Expires="+F.toUTCString()+"; "}G=E?g.encode(G):G;document.cookie=C+"="+G+"; "+A+"Domain="+z.domain+"; Path=/"}catch(D){b.logCaughtError(D)}};this.getCookie=function(C,F){try{var A=new RegExp(C+"=([\\w]+)");var D=document.cookie.match(A);if(!D){return null}if(F!==true){return D[1]}var B=decodeURIComponent(D[1]);return k(B)}catch(E){b.logCaughtError(E)}};this.setCknsIdCookieProperty=function(A,D){try{var E=this.getUserDetailsFromCookie();if(D){E[A]=D}else{delete E[A]}var B=E["jwt-exp"]?E["jwt-exp"]:f.USER_DETAILS_COOKIE_EXPIRE_TIME;z.setCookie(f.USER_DETAILS_COOKIE_NAME,JSON.stringify(E),B,true)}catch(C){b.logCaughtError(C)}};this.unsetCookie=function(A){try{document.cookie=A+"=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain="+z.domain+"; Path=/"}catch(B){b.logCaughtError(B)}};function s(){return window.location.protocol}function r(){v();m()}function v(){if(typeof window.bbccookies==="object"){var A=document.cookie.match(/ckpf_APHID=([^;]*)/);if(A){if(!window.bbccookies.isAllowed("ckpf_APHID")){l()}}}}function m(){var A=z.isIdv5On?/ckns_id=([\w]+)/:/IDENTITY=([^;]*)/;var B=document.cookie.match(A);if(B&&!z.isIdv5On){y(B)}else{if(B&&z.isIdv5On){q(B)}else{n()}}}function y(C){var B=decodeURIComponent(C[1]).split("|");var A=/\:([0-1])$/;var D;if(o(B)&&!x(B[3])){z.valid=true;z.id=B[0];z.username=B[1];if((D=B[5].match(A))!==null){z.rememberme=D.pop()}else{z.rememberme=false}z.displayname=decodeURIComponent(B[2]);z.timestamp=B[3];z.isIdv5On=h["bbcid-v5"]!=="RED"}else{w()}}function q(A){var B=k(A[1]);if(B&&u(B)&&!p(B)){z.valid=true;z.displayname=B.dn;z.timestamp=B["jwt-exp"];z.isIdv5On=h["bbcid-v5"]!=="RED"}else{w()}}function o(A){return(6<=A.length)}function x(B){var C=z.cookieAgeDays*j;var A=(new Date()).getTime();return(A-B>=C)}function u(A){return(A.hasOwnProperty("ps")&&A.hasOwnProperty("jwt-exp")&&A.hasOwnProperty("tkn-exp")&&(A.hy||A.hasOwnProperty("ses-exp")))}function p(B){var C=(new Date()).getTime();var A=B["jwt-exp"]||0;var D=(A<=C);return D}function w(){n();t()}function n(){z.valid=false;z.id="";z.username="~";z.displayname="";z.timestamp=""}function t(){if(z.isIdv5On){z.unsetCookie("ckns_id")}else{z.unsetCookie("IDENTITY");z.unsetCookie("IDENTITY_ENV");l()}}function l(){z.unsetCookie("ckpf_APHID")}}f.getInstance=d;f.setInstance=c;f.downgradeUser=i;return f});